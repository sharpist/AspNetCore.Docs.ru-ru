---
title: Предотвращение атак с открытым перенаправлением в ASP.NET Core
author: ardalis
description: Показано, как предотвратить атаки с открытым перенаправлением для ASP.NET Core приложения.
ms.author: riande
ms.date: 07/07/2017
no-loc:
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: security/preventing-open-redirects
ms.openlocfilehash: eb18c599d84fd08ffe97867b67a837303af188db
ms.sourcegitcommit: d65a027e78bf0b83727f975235a18863e685d902
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2020
ms.locfileid: "85408153"
---
# <a name="prevent-open-redirect-attacks-in-aspnet-core"></a>Предотвращение атак с открытым перенаправлением в ASP.NET Core

Веб-приложение, которое перенаправляет на URL-адрес, указанный через запрос, например строку запроса или данные формы, потенциально может быть изменено для перенаправления пользователей на внешний вредоносный URL-адрес. Такое незаконное изменение называется атакой с открытым перенаправлением.

Каждый раз, когда логика приложения перенаправляется на указанный URL-адрес, необходимо убедиться, что URL-адрес перенаправления не был изменен. ASP.NET Core имеет встроенные функции, помогающие защитить приложения от атак с открытым перенаправлением (также называемых перенаправлением открытия).

## <a name="what-is-an-open-redirect-attack"></a>Что такое атака с открытым перенаправлением?

Веб-приложения часто перенаправляют пользователей на страницу входа, когда они обращаются к ресурсам, требующим проверки подлинности. Перенаправление обычно включает `returnUrl` параметр QueryString, чтобы пользователь мог вернуться к первоначально запрошенному URL-адресу после успешного входа. После проверки подлинности пользователь перенаправляется на URL-адрес, по которому они были изначально запрошены.

Так как URL-адрес назначения указан в запросе QueryString, злоумышленник может изменить строку запроса. Неизмененная строка запроса может позволить сайту перенаправить пользователя на внешний вредоносный сайт. Этот метод называется атакой с открытым перенаправлением (или перенаправлением).

### <a name="an-example-attack"></a>Пример атаки

Злонамеренный пользователь может разработать атаку, предназначенную для предоставления злонамеренному пользователю доступа к учетным данным пользователя или конфиденциальной информации. Чтобы начать атаку, злоумышленник убедится в том, что пользователь должен щелкнуть ссылку на страницу входа вашего сайта со `returnUrl` значением строки запроса, добавленным к URL-адресу. Например, рассмотрим приложение в `contoso.com` , содержащее страницу входа в `http://contoso.com/Account/LogOn?returnUrl=/Home/About` . Атака выполняется следующим образом.

1. Пользователь щелкает вредоносную ссылку `http://contoso.com/Account/LogOn?returnUrl=http://contoso1.com/Account/LogOn` (второй URL-адрес — contoso**1**. com, а не "contoso.com").
2. Пользователь успешно входит в систему.
3. Пользователь перенаправляет (сайт) на `http://contoso1.com/Account/LogOn` (вредоносный сайт, который выглядит точно так же, как и реальный сайт).
4. Пользователь снова входит в систему (выдает вредоносный сайт с учетными данными) и перенаправляется обратно на реальный сайт.

Вероятно, пользователь считает, что первая попытка входа завершилась неудачно, а вторая попытка прошла успешно. Скорее всего, пользователь не знает, что их учетные данные скомпрометированы.

![Открытие процесса атаки с перенаправлением](preventing-open-redirects/_static/open-redirection-attack-process.png)

В дополнение к страницам входа некоторые сайты предоставляют страницы перенаправления или конечные точки. Представьте, что приложение содержит страницу с открытым перенаправлением `/Home/Redirect` . Злоумышленник может создать, например, ссылку в сообщении электронной почты, которое переходит к `[yoursite]/Home/Redirect?url=http://phishingsite.com/Home/Login` . Обычный пользователь будет просматривать URL-адрес и видеть, что он начинается с имени вашего сайта. Если вы доверяете этому, они будут щелкать ссылку. Затем с помощью перенаправления будет отправлен пользователь на фишинговый сайт, который выглядит так же, как и ваш сайт.

## <a name="protecting-against-open-redirect-attacks"></a>Защита от атак с открытым перенаправлением

При разработке веб-приложений рассматривайте все предоставленные пользователем данные как ненадежные. Если в приложении есть функциональные возможности, которые перенаправляют пользователя на основе содержимого URL-адреса, убедитесь, что такие перенаправления выполняются локально в приложении (или на известном URL-адресе, а не в URL-адресе, который может быть предоставлен в строке запроса).

### <a name="localredirect"></a>локалредирект

Используйте `LocalRedirect` вспомогательный метод из базового `Controller` класса:

```csharp
public IActionResult SomeAction(string redirectUrl)
{
    return LocalRedirect(redirectUrl);
}
```

`LocalRedirect`выдаст исключение, если указан нелокальный URL-адрес. В противном случае он ведет себя так же, как и `Redirect` метод.

### <a name="islocalurl"></a>ислокалурл

Используйте метод [ислокалурл](/dotnet/api/Microsoft.AspNetCore.Mvc.IUrlHelper.islocalurl#Microsoft_AspNetCore_Mvc_IUrlHelper_IsLocalUrl_System_String_) для проверки URL-адресов перед перенаправлением:

В следующем примере показано, как проверить, является ли URL-адрес локальным, перед перенаправлением.

```csharp
private IActionResult RedirectToLocal(string returnUrl)
{
    if (Url.IsLocalUrl(returnUrl))
    {
        return Redirect(returnUrl);
    }
    else
    {
        return RedirectToAction(nameof(HomeController.Index), "Home");
    }
}
```

`IsLocalUrl`Метод защищает пользователей от случайного перенаправления к вредоносному сайту. Вы можете записать в журнал сведения о URL-адресе, который был предоставлен, если нелокальный URL-адрес указан в ситуации, когда ожидался локальный URL-адрес. URL-адреса перенаправления журнала могут помочь при диагностике атак перенаправления.
